function ajaxGet(t,e,n){var i;i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t+=t.match(/\?/)?"&":"?time="+(new Date).getTime(),setTimeout(function(){i.abort(),n&&n("timeout")},2e4),i.open("GET",t,!0),i.send(),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?e&&e(i.responseText):n&&n(i.status))}}function ajaxPost(t,e,n,i){var a;a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t+=t.match(/\?/)?"&":"?time="+(new Date).getTime(),setTimeout(function(){a.abort(),i&&i("timeout")},2e4),a.open("POST",t,!0),a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.send(e),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?n&&n(a.responseText):i&&i(a.status))}}function jsonpGet(t,e,n){var i="callback_"+(new Date).getTime()+"_"+Math.random().toString(36).substr(2),a=document.createElement("script");if(a.type="text/javascript",/\?/.test(t)){var o=t.match(/(.*?)\?(.*)/);a.src=o[1]+"?callback="+i+"&"+o[2]}else a.src=t+"?callback="+i;a.timer=setTimeout(function(){n&&n()},1e4),a.onerror=function(){clearTimeout(a.timer),n&&n()},document.body.appendChild(a),window[i]=function(t){clearTimeout(a.timer),window[i]=null,document.body.removeChild(a),e&&e(t)}}function getbdmInfo(t,e,n){var i=t.match("\\d+")[0],a="http://music.baidu.com/data/music/fmlink?songIds="+i+"&type=mp3&rate=";if("string"==typeof e)getoInfo(a+e,i,e,n);else{e.length||(e=["128","192","320","flac"]);for(var o=0;o<e.length;o++)getoInfo(a+e[o],i,e[o],n)}}function getoInfo(t,e,n,i){jsonpGet(t,function(t){var a=t.data.songList[0],o={id:e,rate:n,mp3:a.songLink.replace("yinyueshiting","musicdata").replace(/&src=.*/,""),showLink:a.showLink,cover:a.songPicBig,title:a.songName,time:a.time,artist:a.artistName,lrc:"http://play.baidu.com"+a.lrcLink};i&&i(o)})}function shangLrcLoad(t,e){var n={};n.currentNu=1,n.nextUpdateTime=-1,n.lrc=[],n.audioObj="string"==typeof t?document.getElementById(t):t,n.lrcObj="string"==typeof e?document.getElementById(e):e,n.lrchtmlarr=[],n.divContent=document.createElement("div"),n.repaireTimeNu=0;var i=null;return n.addLrc=function(t,e){n.lrc.push({time:t,lrcstr:e})},n.parseLrc=function(t){for(var e=t.split("\n"),i=0;i<e.length;i++)for(var a=e[i].split("]"),o=0;o<a.length-1;o++){var r=a[o].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/);r&&!/^\s*$/.test(a[a.length-1])&&n.addLrc(60*(+r[1]||0)+(+r[2]||0)+(+r[4]||0)/100,a[a.length-1])}},n.checkUpdate=function(){n.audioObj.currentTime>=n.nextUpdateTime-n.repaireTimeNu&&(n.scrollLrc(),n.checkUpdate())},n.clearClass=function(){for(var t=0;t<n.lrchtmlarr.length;t++)n.lrchtmlarr[t].className=""},n.scrollLrc=function(){if(n.currentNu++,"undefined"!=typeof n.lrc[n.currentNu]){clearInterval(i),n.nextUpdateTime=n.lrc[n.currentNu].time,n.lrchtmlarr[n.currentNu-2].className="",n.lrchtmlarr[n.currentNu-1].className="current";var t=n.lrchtmlarr[n.currentNu-1].moveHeight-300;t=t>0?parseInt(t):0;var e=n.divContent,a=e.scrollTop;i=setInterval(function(){var n=-8,o=(t-a)/-n;o=o>0?Math.ceil(o):Math.floor(o);var r=a+o;e.scrollTop=r,t===r&&clearInterval(i),a=r},30)}},n.init=function(){if(n.addLrc(0,""),n.addLrc(0,""),n.addLrc(999999,""),n.lrc.sort(function(t,e){return t.time-e.time}),n.audioObj.addEventListener("seeked",function(){n.currentNu=1,n.nextUpdateTime=-1}),n.audioObj.addEventListener("timeupdate",function(){n.checkUpdate()}),!window.is_shang_lrc_css){var t=document.createElement("style");t.type="text/css",t.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-track{background:#333}#shang_lrc_div::-webkit-scrollbar-thumb{background:#191919;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(t),window.is_shang_lrc_css=!0}n.divContent.id="shang_lrc_div",n.lrcObj.innerHTML="",n.lrcObj.appendChild(n.divContent);var e=document.createElement("div");n.divContent.appendChild(e);for(var i=0;i<n.lrc.length;i++){var a=document.createElement("p");n.lrchtmlarr.push(a),a.innerHTML=n.lrc[i].lrcstr,e.appendChild(a),a.moveHeight=a.offsetTop}},n}$(document).ready(function(){function t(t,e){var n=document.createElement("a");n.href=t,n.download=e?e:"download";var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i),B.modal("hide")}function e(){v=S.width(),w=H.width();var t=$(window).height()-F.height()-K.height()-50;Q.height(t>0?t:100),V.height(t-50>0?t-50:100)}function n(){e();var t=localStorage.shang_music;if(t&&(re=JSON.parse(t))){te=re.playlistinfo||[];for(var n=0;n<te.length;n++)te[n]&&u(te[n].rate128,n)}}function i(t){y&&(clearTimeout(R.timer),te[Y].rate128.repaireTimeNu=0===t?0:(te[Y].rate128.repaireTimeNu||0)+t,g.repaireTimeNu=te[Y].rate128.repaireTimeNu,R.html("["+g.repaireTimeNu/10+"]"),p(),R.timer=setTimeout(function(){R.html("")},2e3))}function a(t,e){if(ae&&y){var n=t.clientX-S.offset().left,i=n/v;0>i?i=0:i>1&&(i=1);var a=r();i>a&&(i=a),G.width(i*v),E.width(a*v),e&&(y.currentTime=Math.floor(i*y.duration),g.clearClass())}}function o(t){if(oe){var e=t.clientX-H.offset().left,n=e/w;0>n?n=0:n>1&&(n=1),_.width(100*n+"%"),Z=n,y&&(y.volume=n,y.muted&&(y.muted=!1,C.attr("src","./images/volume.png")))}}function r(){if(!y)return 0;var t=y.buffered;if(t.length){var e=t.end(t.length-1),n=e/y.duration;return n}}function c(t){if(t){for(var e=-1,n=0;n<te.length;n++)if(te[n]&&t===te[n].rate128.id){e=n;break}if(-1!==e){q.show();var i=z.html();z.html("已经在列表中,点击确定跳转播放"),B.modal("show"),J.html("返回"),J.get(0).dataset.dismiss="",J.one("click",function(){z.html(i),J.html("关闭"),setTimeout(function(){J.get(0).dataset.dismiss="modal"},200)}),q.one("click",function(){B.modal("hide"),Y=e,d(Y)})}else{var a={};te.push(a),getbdmInfo(t,["128"],function(t){if(a["rate"+t.rate]=t,"128"===t.rate){if(Y=te.length-1,/pan.baidu/.test(t.showLink)){te.length=te.length-1;var e=z.html();z.html("此音乐为网网盘音乐, 点击确定打开此音乐网盘地址, 点击返回重新选取"),q.show(),J.html("返回"),q.html('<a href="'+t.showLink+'" target = "_blank" style="color: white">跳转</a>'),q.one("click",function(){return B.modal("hide"),!0}),J.get(0).dataset.dismiss="",J.one("click",function(){z.html(e),J.html("关闭"),q.hide(),setTimeout(function(){J.get(0).dataset.dismiss="modal"},200)})}else d(Y,!0),B.modal("hide");p()}})}}else l(L.val())}function l(t){if(!t)return z.html("请输入 歌曲名/歌手/百度音乐ID链接"),q.hide(),B.modal("show"),void setTimeout(function(){B.modal("hide")},3e3);var e="http://121.40.81.63:1337/";ajaxGet(e+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+t+"&version=2&from=0"),function(t){var e=JSON.parse(t).data,n=$('<div id="searchsongdiv">');if(e.song.length){for(var i=$("<ul>"),a=0;a<e.song.length;a++){var o=e.song[a],r=$('<li data-songid="'+o.songid+'">');r.html('<hr><div class="row"> <div class="col-md-7 col-xs-5 text-nowrap" title="'+(o.songname||"SHANG")+'">'+(o.songname||"SHANG")+'</div><div class="col-md-4 col-xs-5 text-nowrap" title="'+(o.artistname||"SHANG")+'">'+(o.artistname||"SHANG")+'</div><div class="col-md-1 col-xs-2"><img class="liimg pull-left" src="images/download.png"/></div></div>'),i.append(r)}n.append(i)}else n.html("未找到....");z.html(""),z.append(n),q.hide(),B.modal("show")})}function d(t,e,n){var i=!1;if(!te[t])return void m(n||1);var a=te[t].rate128;return/pan.baidu/.test(a.showLink)?(z.html("此音乐为百度网盘音乐, 删除并播放下一首?"),q.show(),B.modal("show"),void q.one("click",function(){1!==te.length&&m(1),P.find("li").each(function(){$(this).find("img").first().trigger("click")})})):(y&&(i=y.muted,document.body.removeChild(y)),y=document.createElement("audio"),y.innerHTML="<source src="+a.mp3+">",document.body.appendChild(y),y.volume=Z,y.play(),Y=t,ne||(x.attr("src","./images/pause.png"),ne=!0),i&&(y.muted=i,C.attr("src","./images/mute.png")),$(y).on("timeupdate",function(){h()}),$(y).on("ended",function(){m(1)}),g=shangLrcLoad(y,"lrcdiv"),jsonpGet("http://cors.coding.io?method=get&url="+a.lrc,function(t){g.parseLrc(t.data),g.repaireTimeNu=a.repaireTimeNu||0,g.init()}),void s(a,t,e))}function s(t,e,n){A.html(t.title||"SHANG"),O.html(t.artist||"SHANG"),I.attr("src",t.cover||"http://i1.tietuku.com/f3f9084123926501.jpg"),n&&u(t,e),P.find("li").each(function(t){$(this).data("nu")===e?ee[t].addClass("playing"):ee[t].removeClass("playing")})}function u(t,e){var n=t.time||0,i=Math.floor(n/60),a=Math.round(n%60)<10?"0"+Math.round(n%60):Math.round(n%60),o=$("<li>");o.html('<hr><div class="row"> <div class="col-md-7 col-xs-6 text-nowrap" title="'+(t.title||"SHANG")+" - "+(t.artist||"SHANG")+'">'+(t.title||"SHANG")+" - "+(t.artist||"SHANG")+'</div><div class="col-md-2 col-xs-3 text-right">'+(i+":"+a)+'</div><div class="col-md-2 col-xs-3"><img id="imgdel" class="liimg pull-left" src="images/delete.png"/><img class="liimg pull-left" src="images/download.png"/></div></div>'),o.data("nu",e),P.append(o),ee.push(o)}function m(t){-1!==Y&&(Y=(Y+te.length+t)%te.length,d(Y,!1,t))}function h(){if(y){var t=y.currentTime,e=Math.floor(t/60),n=Math.round(t%60)<10?"0"+Math.round(t%60):Math.round(t%60);X.html(e+":"+n),ae||(G.width(y.currentTime/y.duration*v),E.width(r()*v))}}function f(){y&&(document.body.removeChild(y),y=null,Y=-1),P.html(""),$("#lrcdiv").html(""),A.html("SHANG"),O.html("SHANG"),I.attr("src","http://i1.tietuku.com/f3f9084123926501.jpg"),G.width(0),E.width(0),X.html("")}function p(){for(var t=[],e=!1,n=0;n<te.length;n++)te[n]&&(t.push(te[n]),e=!0);return re.playlistinfo=t,localStorage.shang_music=JSON.stringify(re),e}var g,v,w,b,k,y=null,T=$("#addandplay"),N=$(".mayplay"),L=$("#addr"),x=$("#playpaush"),j=$("#previewsong"),M=$("#nextsong"),C=$("#mute"),H=$("#volumebar"),_=$("#currentvolumebar"),S=$("#progressbar"),G=$("#currentprogress"),E=$("#loadedprogress"),I=$("#coverimg"),A=$("#title"),O=$("#artist"),X=$("#info"),P=$("#alllistul"),U=$("#lrctimereduce"),D=$("#lrctimeadd"),R=$("#lrctimecurrent"),q=$("#ensurebtn"),B=$("#showtext"),J=$("#notsurebtn"),z=$(".textdiv"),F=$("#searcharea"),K=$("#player"),Q=$("#alllist"),V=$("#lrcdiv"),W=$("#download"),Y=-1,Z=1,te=[],ee=[],ne=!0,ie=null,ae=!1,oe=!1,re={};n(),$(window).on("resize",function(){e()}),$(window).on("beforeunload",function(){return(new Date).getTime()-(k||0)>1e3?"提示: ":void 0}),P.on("click","li",function(t){var e=$(this).data("nu");d(e,!1),t.stopPropagation()}),P.on("click","li img",function(t){var e=$(this).parents("li.maydelete"),n=e.data("nu");if("imgdel"===t.target.id){te[n]=void 0,ee.splice(n,1),e.remove();var i=p();n===Y&&(i?m(1):f())}else n>=0&&(z.html('<a data-rate="128" href = "javascript:void(0);">128</a><br><a data-rate="192" href = "javascript:void(0);">192</a><br><a data-rate="320" href = "javascript:void(0);">320</a><br><a data-rate="flac" href = "javascript:void(0);">flac</a>'),B.modal("show"),q.hide(),b=te[n].rate128.id);t.stopPropagation()}),P.on("mouseover","li",function(){$(this).addClass("maydelete"),$(this).find("img").removeClass("visible-xs"),$(this).find("img").css("display","block")}),P.on("mouseout","li",function(){$(this).removeClass("maydelete"),$(this).find("img").addClass("visible-xs"),$(this).find("img").css("display","none")}),z.on("click","li",function(t){var e=""+$(this).data("songid");c(e),t.stopPropagation()}),z.on("click","a",function(){getbdmInfo(b,[this.getAttribute("data-rate")],function(e){k=(new Date).getTime(),/pan.baidu/.test(e.showLink)?prompt("网盘音乐,请复制链接下载~~",e.mp3):t(e.mp3)})}),z.on("click","li img",function(t){b=$(this).parents("li").data("songid")+"",z.html('<a data-rate="128" href = "javascript:void(0);">128</a><br><a data-rate="192" href = "javascript:void(0);">192</a><br><a data-rate="320" href = "javascript:void(0);">320</a><br><a data-rate="flac" href = "javascript:void(0);">flac</a>'),B.modal("show"),q.hide(),t.stopPropagation()}),$(document).on("keydown",function(t){13===t.keyCode&&N.first().trigger("click")}),$(document).on("mousedown",function(){(ae||oe)&&(document.body.style.cursor="pointer")}),$(document).on("mouseup",function(t){a(t,!0),o(t),ae=!1,oe=!1,document.body.style.cursor="default"}),$(document).on("mousemove",function(t){return a(t),o(t),"addr"===t.target.id}),S.on("mousedown",function(){ae=!0}),H.on("mousedown",function(){oe=!0}),L.on("focus",function(){L.select()}),U.on("click",function(){i(-1)}),D.on("click",function(){i(1)}),R.on("click",function(){i(0)}),W.on("click",function(){Y>=0&&(b=te[Y].rate128.id,z.html('<a data-rate="128" href = "javascript:void(0);">128</a><br><a data-rate="192" href = "javascript:void(0);">192</a><br><a data-rate="320" href = "javascript:void(0);">320</a><br><a data-rate="flac" href = "javascript:void(0);">flac</a>'),B.modal("show"),q.hide())}),B.on("hidden.bs.modal",function(){N.first().button("reset"),q.show(),q.unbind(),J.html("关闭"),J.unbind(),clearTimeout(ie)}),N.each(function(t){!function(t,e){$(e).on("click",function(){N.first().button("loading"),ie=setTimeout(function(){T.button("reset")},5e3);var e=L.val().match("\\d{9,}"),n="";e?1===t?(n=e[0],c(n)):(J.html("否"),J.get(0).dataset.dismiss="",z.html("检测到ID,直接播放?"),B.modal("show"),q.one("click",function(){n=e[0],c(n)}),J.one("click",function(){J.html("关闭"),c(""),setTimeout(function(){J.get(0).dataset.dismiss="modal"},200)})):c("")})}(t,this)}),T.on("click",function(){T.button("loading"),ie=setTimeout(function(){T.button("reset")},1e4);var t=L.val();if(!t)return z.html("请输入 搜索内容!"),q.hide(),void B.modal("show");var e=t.match("\\d+"),n="";e&&(n=e[0]);for(var i=-1,a=0;a<te.length;a++)if(n===te[a].rate128.id){i=a;break}if(-1!==i)return z.html("已经在列表中,点击确定跳转播放"),B.modal("show"),void q.one("click",function(){B.modal("hide"),Y=i,d(Y)});var o={};te.push(o),getbdmInfo(n,[],function(t){o["rate"+t.rate]=t,"128"===t.rate&&(T.button("reset"),Y=te.length-1,d(Y,!0),p())})}),j.on("click",function(){m(-1)}),M.on("click",function(){m(1)}),C.on("click",function(){y&&(y.muted?(y.muted=!1,C.attr("src","./images/volume.png")):(y.muted=!0,C.attr("src","./images/mute.png")))}),x.on("click",function(){y&&(ne?(y.pause(),x.attr("src","./images/play.png"),ne=!1):(y.play(),x.attr("src","./images/pause.png"),ne=!0))})});