function ajaxGet(t,e,n){var i;i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t+=t.match(/\?/)?"&":"?time="+(new Date).getTime(),setTimeout(function(){i.abort(),n&&n("timeout")},2e4),i.open("GET",t,!0),i.send(),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?e&&e(i.responseText):n&&n(i.status))}}function ajaxPost(t,e,n,i){var o;o=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t+=t.match(/\?/)?"&":"?time="+(new Date).getTime(),setTimeout(function(){o.abort(),i&&i("timeout")},2e4),o.open("POST",t,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send(e),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?n&&n(o.responseText):i&&i(o.status))}}function jsonpGet(t,e,n){var i="callback_"+(new Date).getTime()+"_"+Math.random().toString(36).substr(2),o=document.createElement("script");if(o.type="text/javascript",/\?/.test(t)){var a=t.match(/(.*?)\?(.*)/);o.src=a[1]+"?callback="+i+"&"+a[2]}else o.src=t+"?callback="+i;o.timer=setTimeout(function(){n&&n()},1e4),o.onerror=function(){clearTimeout(o.timer),n&&n()},document.body.appendChild(o),window[i]=function(t){clearTimeout(o.timer),window[i]=null,document.body.removeChild(o),e&&e(t)}}function getbdmInfo(t,e,n){var i=t.match("\\d+")[0],o="http://music.baidu.com/data/music/fmlink?songIds="+i+"&type=mp3&rate=";if("string"==typeof e)getoInfo(o+e,i,e,n);else{e.length||(e=["128","192","320","flac"]);for(var a=0;a<e.length;a++)getoInfo(o+e[a],i,e[a],n)}}function getoInfo(t,e,n,i){jsonpGet(t,function(t){var o=t.data.songList[0],a={id:e,rate:n,downloadhref:"http://yinyueyun.baidu.com/data/cloud/downloadsongfile?songIds="+e+"&rate="+("flac"===n?835:n)+"&format="+n,mp3:o.songLink.replace("yinyueshiting","musicdata").replace(/&src=.*/,""),showLink:o.showLink,cover:o.songPicBig,title:o.songName,time:o.time,artist:o.artistName,lrc:"http://play.baidu.com"+o.lrcLink};i&&i(a)})}function shangLrcLoad(t,e){var n={};n.currentNu=1,n.nextUpdateTime=-1,n.lrc=[],n.audioObj="string"==typeof t?document.getElementById(t):t,n.lrcObj="string"==typeof e?document.getElementById(e):e,n.lrchtmlarr=[],n.divContent=document.createElement("div"),n.repaireTimeNu=0;var i=null;return n.addLrc=function(t,e){n.lrc.push({time:t,lrcstr:e})},n.parseLrc=function(t){for(var e=t.split("\n"),i=0;i<e.length;i++)for(var o=e[i].split("]"),a=0;a<o.length-1;a++){var r=o[a].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/);r&&!/^\s*$/.test(o[o.length-1])&&n.addLrc(60*(+r[1]||0)+(+r[2]||0)+(+r[4]||0)/100,o[o.length-1])}},n.checkUpdate=function(){n.audioObj.currentTime>=n.nextUpdateTime-n.repaireTimeNu&&(n.scrollLrc(),n.checkUpdate())},n.clearClass=function(){for(var t=0;t<n.lrchtmlarr.length;t++)n.lrchtmlarr[t].className=""},n.scrollLrc=function(){if(n.currentNu++,"undefined"!=typeof n.lrc[n.currentNu]){clearInterval(i),n.nextUpdateTime=n.lrc[n.currentNu].time,n.lrchtmlarr[n.currentNu-2].className="",n.lrchtmlarr[n.currentNu-1].className="current";var t=n.lrchtmlarr[n.currentNu-1].moveHeight-300;t=t>0?parseInt(t):0;var e=n.divContent,o=e.scrollTop;i=setInterval(function(){var n=-8,a=(t-o)/-n;a=a>0?Math.ceil(a):Math.floor(a);var r=o+a;e.scrollTop=r,t===r&&clearInterval(i),o=r},30)}},n.init=function(){if(n.addLrc(0,""),n.addLrc(0,""),n.addLrc(999999,""),n.lrc.sort(function(t,e){return t.time-e.time}),n.audioObj.addEventListener("seeked",function(){n.currentNu=1,n.nextUpdateTime=-1}),n.audioObj.addEventListener("timeupdate",function(){n.checkUpdate()}),!window.is_shang_lrc_css){var t=document.createElement("style");t.type="text/css",t.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-track{background:#333}#shang_lrc_div::-webkit-scrollbar-thumb{background:#191919;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(t),window.is_shang_lrc_css=!0}n.divContent.id="shang_lrc_div",n.lrcObj.innerHTML="",n.lrcObj.appendChild(n.divContent);var e=document.createElement("div");n.divContent.appendChild(e);for(var i=0;i<n.lrc.length;i++){var o=document.createElement("p");n.lrchtmlarr.push(o),o.innerHTML=n.lrc[i].lrcstr,e.appendChild(o),o.moveHeight=o.offsetTop}},n}$(document).ready(function(){function t(){K.html('如果下载的码率不存在,默认下载为128码率[如果文件大小为3~4M就是128码率]<br><a data-rate="128" href = "javascript:void(0);">128</a><br><a data-rate="192" href = "javascript:void(0);">192</a><br><a data-rate="320" href = "javascript:void(0);">320</a><br><a data-rate="flac" href = "javascript:void(0);">flac</a>'),z.modal("show"),J.hide()}function e(t,e){var n=document.createElement("a");n.href=t,n.target="_blank",n.download=e?e:"download";var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)}function n(){b=G.width(),y=j.width();var t=$(window).height()-Q.height()-V.height()-50;W.height(t>0?t:100),Y.height(t-50>0?t-50:100)}function i(){n();var t=localStorage.shang_music;if(t&&(de=JSON.parse(t))){se=de.isSingle,se||te.attr("src","images/all.png"),ue=de.lastPlayId||0,ie=de.playlistinfo||[];for(var e=0;e<ie.length;e++)if(ie[e]){var i=ie[e].rate128;s(i),f(i,e),i.id===ue&&u(e,!1)}}}function o(t){N&&(clearTimeout(B.timer),ie[ee].rate128.repaireTimeNu=0===t?0:(ie[ee].rate128.repaireTimeNu||0)+t,w.repaireTimeNu=ie[ee].rate128.repaireTimeNu,B.html("["+w.repaireTimeNu/10+"]"),v(),B.timer=setTimeout(function(){B.html("")},2e3))}function a(t,e){if(ce&&N){var n=t.clientX-G.offset().left,i=n/b;0>i?i=0:i>1&&(i=1);var o=c();i>o&&(i=o),A.width(i*b),E.width(o*b),e&&(N.currentTime=Math.floor(i*N.duration),w.clearClass())}}function r(t){if(le){var e=t.clientX-j.offset().left,n=e/y;0>n?n=0:n>1&&(n=1),S.width(100*n+"%"),ne=n,N&&(N.volume=n,N.muted&&(N.muted=!1,H.attr("src","./images/volume.png")))}}function c(){if(!N)return 0;var t=N.buffered;if(t.length){var e=t.end(t.length-1),n=e/N.duration;return n}}function l(t){if(t){for(var e=-1,n=0;n<ie.length;n++)if(ie[n]&&t===ie[n].rate128.id){e=n;break}if(-1!==e){J.show();var i=K.html();K.html("已经在列表中,点击确定跳转播放"),z.modal("show"),F.html("返回"),F.get(0).dataset.dismiss="",F.one("click",function(){K.html(i),F.html("关闭"),setTimeout(function(){F.get(0).dataset.dismiss="modal"},200)}),J.one("click",function(){z.modal("hide"),ee=e,u(ee)})}else{var o={};ie.push(o),getbdmInfo(t,["128"],function(t){o["rate"+t.rate]=t,"128"===t.rate&&(ee=ie.length-1,/pan.baidu/.test(t.showLink)?(t.mp3=me+"?fun=fun&url="+encodeURIComponent(t.mp3),u(ee,!0),z.modal("hide")):(u(ee,!0),z.modal("hide")),v())})}}else d(C.val())}function d(t){return t?void ajaxGet(me+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+t+"&version=2&from=0"),function(t){var e=JSON.parse(t).data,n=$('<div id="searchsongdiv">');if(e.song.length){for(var i=$("<ul>"),o=0;o<e.song.length;o++){var a=e.song[o],r=$('<li data-songid="'+a.songid+'">');r.html('<hr><div class="row"> <div class="col-md-7 col-xs-5 text-nowrap" title="'+(a.songname||"SHANG")+'">'+(a.songname||"SHANG")+'</div><div class="col-md-4 col-xs-5 text-nowrap" title="'+(a.artistname||"SHANG")+'">'+(a.artistname||"SHANG")+'</div><div class="col-md-1 col-xs-2"><img class="liimg pull-left" src="images/download.png"/></div></div>'),i.append(r)}n.append(i)}else n.html("未找到....");K.html(""),K.append(n),J.hide(),z.modal("show")}):(K.html("请输入 歌曲名/歌手/百度音乐ID链接"),J.hide(),z.modal("show"),void(re=setTimeout(function(){z.modal("hide")},3e3)))}function s(t){var e=decodeURIComponent(t.mp3.replace(/(.*url=)|(xcode.*)/gi,""));/file.qianqian.com/.test(e)&&(!t.timeUpdate||(new Date).getTime()-t.timeUpdate>864e5)&&getbdmInfo(t.id,["128"],function(n){t.mp3=me+"?fun=fun&url="+encodeURIComponent(n.mp3),t.timeUpdate=(new Date).getTime(),v(t.id),N&&decodeURIComponent(N.src).match(e)&&N.currentTime<500&&(N.src=null,N.load(),N.src=t.mp3,N.play(),ae||N.pause())})}function u(t,e,n,i){if(!ie[t])return void h(n||1);var o=ie[t].rate128;N?(N.src=null,N.load()):(N=new Audio,N.onerror=function(t){},N.ontimeupdate=function(){p()},N.onended=function(){h(1)}),N.src=o.mp3,N.play(),ee=t,A.width(0),E.width(0),i&&(M.attr("src","./images/pause.png"),ae=!0),ae||N.pause(),w=shangLrcLoad(N,"lrcdiv"),jsonpGet("http://cors.coding.io?method=get&url="+o.lrc,function(t){w.parseLrc(t.data),w.repaireTimeNu=o.repaireTimeNu||0,w.init()},function(){w.parseLrc("[00:00]未找到(┬＿┬)"),w.repaireTimeNu=o.repaireTimeNu||0,w.init()}),m(o,t,e)}function m(t,e,n){O.html(t.title||"SHANG"),P.html(t.artist||"SHANG"),U.attr("src",t.cover&&me+"?fun=fun&url="+t.cover||"http://i1.tietuku.com/f3f9084123926501.jpg"),n&&f(t,e),X.find("li").each(function(t){$(this).data("nu")===e?oe[t].addClass("playing"):oe[t].removeClass("playing")})}function f(t,e){var n=t.time||0,i=Math.floor(n/60),o=Math.round(n%60)<10?"0"+Math.round(n%60):Math.round(n%60),a=$("<li>");a.html('<hr><div class="row"> <div class="col-md-7 col-xs-6 text-nowrap" title="'+(t.title||"SHANG")+" - "+(t.artist||"SHANG")+'">'+(t.title||"SHANG")+" - "+(t.artist||"SHANG")+'</div><div class="col-md-2 col-xs-3 text-right">'+(i+":"+o)+'</div><div class="col-md-2 col-xs-3"><img id="imgdel" class="liimg pull-left" src="images/delete.png"/><img class="liimg pull-left" src="images/download.png"/></div></div>'),a.data("nu",e),X.append(a),oe.push(a)}function h(t,e){if(-1!==ee){if(se&&!e)return void u(ee,!1,t);ee=(ee+ie.length+t)%ie.length,u(ee,!1,t)}}function p(){if(N){var t=N.currentTime,e=Math.floor(t/60),n=Math.round(t%60)<10?"0"+Math.round(t%60):Math.round(t%60);R.html(e+":"+n),ce||(A.width(N.currentTime/N.duration*b),E.width(c()*b))}}function g(){N&&(document.body.removeChild(N),N=null,ee=-1),X.html(""),$("#lrcdiv").html(""),O.html("SHANG"),P.html("SHANG"),U.attr("src","http://i1.tietuku.com/f3f9084123926501.jpg"),A.width(0),E.width(0),R.html("")}function v(t){for(var e=[],n=!1,i=0;i<ie.length;i++)ie[i]&&(e.push(ie[i]),n=!0);return de.playlistinfo=e,de.isSingle=se,t&&(de.lastPlayId=t),localStorage.shang_music=JSON.stringify(de),n}var w,b,y,T,k,N=null,x=$("#addandplay"),L=$(".mayplay"),C=$("#addr"),M=$("#playpaush"),I=$("#previewsong"),_=$("#nextsong"),H=$("#mute"),j=$("#volumebar"),S=$("#currentvolumebar"),G=$("#progressbar"),A=$("#currentprogress"),E=$("#loadedprogress"),U=$("#coverimg"),O=$("#title"),P=$("#artist"),R=$("#info"),X=$("#alllistul"),D=$("#lrctimereduce"),q=$("#lrctimeadd"),B=$("#lrctimecurrent"),J=$("#ensurebtn"),z=$("#showtext"),F=$("#notsurebtn"),K=$(".textdiv"),Q=$("#searcharea"),V=$("#player"),W=$("#alllist"),Y=$("#lrcdiv"),Z=$("#download"),te=$("#single"),ee=-1,ne=1,ie=[],oe=[],ae=!0,re=null,ce=!1,le=!1,de={},se=!1,ue=-1,me="http://cors.coding.io/";i(),$(window).on("resize",function(){n()}),$(window).on("beforeunload",function(){return(new Date).getTime()-(k||0)>1e3?(v(ie[ee].rate128.id),"提示: "):void 0}),X.on("click","li",function(t){var e=$(this).data("nu");u(e,!1,null,!0),t.stopPropagation()}),X.on("click","li img",function(e){var n=$(this).parents("li.maydelete"),i=n.data("nu");if("imgdel"===e.target.id){ie[i]=void 0,oe.splice(i,1),n.remove();var o=v();i===ee&&(o?h(1):g())}else i>=0&&(T=ie[i].rate128.id,t());e.stopPropagation()}),X.on("mouseover","li",function(){$(this).addClass("maydelete"),$(this).find("img").removeClass("visible-xs"),$(this).find("img").css("display","block")}),X.on("mouseout","li",function(){$(this).removeClass("maydelete"),$(this).find("img").addClass("visible-xs"),$(this).find("img").css("display","none")}),K.on("click","li",function(t){var e=""+$(this).data("songid");l(e),t.stopPropagation()}),K.on("click","a",function(){getbdmInfo(T,[this.getAttribute("data-rate")],function(t){k=(new Date).getTime(),e(/pan.baidu/.test(t.showLink)?t.mp3.match(me)?t.mp3:me+"?fun=fun&url="+t.mp3:t.mp3)})}),K.on("click","li img",function(e){T=$(this).parents("li").data("songid")+"",t(),e.stopPropagation()}),$(document).on("keydown",function(t){13===t.keyCode&&L.first().trigger("click")}),$(document).on("mousedown",function(){(ce||le)&&(document.body.style.cursor="pointer")}),$(document).on("mouseup",function(t){a(t,!0),r(t),ce=!1,le=!1,document.body.style.cursor="default"}),$(document).on("mousemove",function(t){return a(t),r(t),"addr"===t.target.id||"backdownload"===t.target.id}),G.on("mousedown",function(){ce=!0}),j.on("mousedown",function(){le=!0}),C.on("focus",function(){setTimeout(function(){C.select()},20)}),D.on("click",function(){o(-1)}),q.on("click",function(){o(1)}),B.on("click",function(){o(0)}),Z.on("click",function(){ee>=0&&(T=ie[ee].rate128.id,t())}),te.on("click",function(){se=!se,se?te.attr("src","images/single.png"):te.attr("src","images/all.png")}),z.on("hidden.bs.modal",function(){L.first().button("reset"),J.show(),J.unbind(),F.html("关闭"),F.unbind(),clearTimeout(re),F.get(0).dataset.dismiss="modal"}),L.each(function(t){!function(t,e){$(e).on("click",function(){L.first().button("loading"),re=setTimeout(function(){x.button("reset")},5e3);var e=C.val().match("\\d{7,}"),n="";e?1===t?(n=e[0],l(n)):(F.html("否"),F.get(0).dataset.dismiss="",K.html("检测到ID,直接播放?"),z.modal("show"),J.one("click",function(){n=e[0],l(n)}),F.one("click",function(){F.html("关闭"),l(""),setTimeout(function(){F.get(0).dataset.dismiss="modal"},200)})):l("")})}(t,this)}),x.on("click",function(){x.button("loading"),re=setTimeout(function(){x.button("reset")},1e4);var t=C.val();if(!t)return K.html("请输入 搜索内容!"),J.hide(),void z.modal("show");var e=t.match("\\d+"),n="";e&&(n=e[0]);for(var i=-1,o=0;o<ie.length;o++)if(n===ie[o].rate128.id){i=o;break}if(-1!==i)return K.html("已经在列表中,点击确定跳转播放"),z.modal("show"),void J.one("click",function(){z.modal("hide"),ee=i,u(ee)});var a={};ie.push(a),getbdmInfo(n,["128"],function(t){a["rate"+t.rate]=t,"128"===t.rate&&(x.button("reset"),ee=ie.length-1,u(ee,!0),v())})}),I.on("click",function(){h(-1,!0)}),_.on("click",function(){h(1,!0)}),H.on("click",function(){N&&(N.muted?(N.muted=!1,H.attr("src","./images/volume.png")):(N.muted=!0,H.attr("src","./images/mute.png")))}),M.on("click",function(){N&&(ae?(N.pause(),M.attr("src","./images/play.png"),ae=!1):(N.play(),M.attr("src","./images/pause.png"),ae=!0))})});