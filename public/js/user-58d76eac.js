function getbdmInfo(t,e,n){var i=t.match("\\d+")[0],o="http://music.baidu.com/data/music/fmlink?songIds="+i+"&type=mp3&rate=";if("string"==typeof e)getoInfo(o+e,i,e,n);else{e.length||(e=["128","192","320","flac"]);for(var r=0;r<e.length;r++)getoInfo(o+e[r],i,e[r],n)}}function getoInfo(t,e,n,i){jsonpGet(t,function(t){var o=t.data.songList[0],r={id:e,rate:n,mp3:o.showLink.replace("yinyueshiting","musicdata"),cover:o.songPicBig,title:o.songName,time:o.time,artist:o.artistName,lrc:"http://play.baidu.com"+o.lrcLink};i&&i(r)})}function ajaxGet(t,e,n){var i;i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t+=t.match(/\?/)?"&":"?time="+(new Date).getTime(),setTimeout(function(){i.abort(),n&&n("timeout")},2e4),i.open("GET",t,!0),i.send(),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?e&&e(i.responseText):n&&n(i.status))}}function ajaxPost(t,e,n,i){var o;o=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t+=t.match(/\?/)?"&":"?time="+(new Date).getTime(),setTimeout(function(){o.abort(),i&&i("timeout")},2e4),o.open("POST",t,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send(e),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?n&&n(o.responseText):i&&i(o.status))}}function jsonpGet(t,e,n){var i="callback_"+(new Date).getTime()+"_"+Math.random().toString(36).substr(2),o=document.createElement("script");if(o.type="text/javascript",/\?/.test(t)){var r=t.match(/(.*?)\?(.*)/);o.src=r[1]+"?callback="+i+"&"+r[2]}else o.src=t+"?callback="+i;o.timer=setTimeout(function(){n&&n()},1e4),o.onerror=function(){clearTimeout(o.timer),n&&n()},document.body.appendChild(o),window[i]=function(t){clearTimeout(o.timer),window[i]=null,document.body.removeChild(o),e&&e(t)}}function shangLrcLoad(t,e){var n={};n.currentNu=1,n.nextUpdateTime=-1,n.lrc=[],n.audioObj="string"==typeof t?document.getElementById(t):t,n.lrcObj="string"==typeof e?document.getElementById(e):e,n.lrchtmlarr=[],n.divContent=document.createElement("div"),n.repaireTimeNu=0;var i=null;return n.addLrc=function(t,e){n.lrc.push({time:t,lrcstr:e})},n.parseLrc=function(t){for(var e=t.split("\n"),i=0;i<e.length;i++)for(var o=e[i].split("]"),r=0;r<o.length-1;r++){var a=o[r].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/);a&&!/^\s*$/.test(o[o.length-1])&&n.addLrc(60*(+a[1]||0)+(+a[2]||0)+(+a[4]||0)/100,o[o.length-1])}},n.checkUpdate=function(){n.audioObj.currentTime>=n.nextUpdateTime-n.repaireTimeNu&&(n.scrollLrc(),n.checkUpdate())},n.clearClass=function(){for(var t=0;t<n.lrchtmlarr.length;t++)n.lrchtmlarr[t].className=""},n.scrollLrc=function(){if(n.currentNu++,"undefined"!=typeof n.lrc[n.currentNu]){clearInterval(i),n.nextUpdateTime=n.lrc[n.currentNu].time,n.lrchtmlarr[n.currentNu-2].className="",n.lrchtmlarr[n.currentNu-1].className="current";var t=n.lrchtmlarr[n.currentNu-1].moveHeight-300;t=t>0?parseInt(t):0;var e=n.divContent,o=e.scrollTop;i=setInterval(function(){var n=-8,r=(t-o)/-n;r=r>0?Math.ceil(r):Math.floor(r);var a=o+r;e.scrollTop=a,t===a&&clearInterval(i),o=a},30)}},n.init=function(){if(n.addLrc(0,""),n.addLrc(0,""),n.addLrc(999999,""),n.lrc.sort(function(t,e){return t.time-e.time}),n.audioObj.addEventListener("seeked",function(){n.currentNu=1,n.nextUpdateTime=-1}),n.audioObj.addEventListener("timeupdate",function(){n.checkUpdate()}),!window.is_shang_lrc_css){var t=document.createElement("style");t.type="text/css",t.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-track{background:#333}#shang_lrc_div::-webkit-scrollbar-thumb{background:#191919;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(t),window.is_shang_lrc_css=!0}n.divContent.id="shang_lrc_div",n.lrcObj.innerHTML="",n.lrcObj.appendChild(n.divContent);var e=document.createElement("div");n.divContent.appendChild(e);for(var i=0;i<n.lrc.length;i++){var o=document.createElement("p");n.lrchtmlarr.push(o),o.innerHTML=n.lrc[i].lrcstr,e.appendChild(o),o.moveHeight=o.offsetTop}},n}$(document).ready(function(){function t(t){u&&(clearTimeout(H.timer),I[j].repaireTimeNu=0===t?0:(I[j].repaireTimeNu||0)+t,P.repaireTimeNu=I[j].repaireTimeNu,H.html("["+P.repaireTimeNu/10+"]"),H.timer=setTimeout(function(){H.html(""),U.playlistinfo=I,localStorage.shang_music=JSON.stringify(U)},2e3))}function e(t,e){if(R&&u){var n=t.clientX-y.offset().left,i=n/q;0>i?i=0:i>1&&(i=1),T.width(100*i+"%"),e&&(u.currentTime=Math.floor(i*u.duration),P.clearClass())}}function n(t){if(D){var e=t.clientX-w.offset().left,n=e/B;0>n?n=0:n>1&&(n=1),x.width(100*n+"%"),G=n,u&&(u.volume=n,u.muted&&(u.muted=!1,b.attr("src","./images/volume.png")))}}function i(t){if(t){for(var e=-1,n=0;n<I.length;n++)if(t===I[n].rate128.id){e=n;break}if(-1!==e)$("#ensurebtn").show(),$(".textdiv").html("已经在列表中,点击确定跳转播放"),$("#showtext").modal("show"),$("#ensurebtn").one("click",function(){$("#showtext").modal("hide"),j=e,r(j)});else{var a={};I.push(a),getbdmInfo(t,[],function(t){if(a["rate"+t.rate]=t,"128"===t.rate){if(j=I.length-1,/pan.baidu/.test(t.mp3)){I.length=I.length-1;var e=$(".textdiv").html();$(".textdiv").html("此音乐为百度网盘音乐, 点击确定打开此音乐网盘地址, 点击返回重新选取"),$("#ensurebtn").show(),$("#notsurebtn").html("返回"),$("#ensurebtn").one("click",function(){$("#showtext").modal("hide"),window.open(t.mp3)}),$("#notsurebtn").one("click",function(){$(".textdiv").html(e),setTimeout(function(){$("#showtext").modal("show"),$(".textdiv").find("li").each(function(){$(this).on("click",function(){var t=$(this).data("songid")+"";i(t)})})},500)})}else r(j,!0),$("#showtext").modal("hide");U.playlistinfo=I,localStorage.shang_music=JSON.stringify(U)}})}}else o(f.val())}function o(t){if(!t)return $(".textdiv").html("请输入 歌曲名/歌手/百度音乐ID链接"),$("#ensurebtn").hide(),$("#showtext").modal("show"),void setTimeout(function(){$("#showtext").modal("hide")},3e3);var e="http://azure.xinshangshangxin.com/getbyurl";ajaxGet(e+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+t+"&version=2&from=0"),function(t){for(var e=JSON.parse(t).data,n=$('<div id="searchsongdiv">'),o=$("<ul>"),r=0;r<e.song.length;r++){var a=e.song[r],c=$('<li data-songid="'+a.songid+'">');c.html('<hr><div class="row"> <div class="col-md-8 col-xs-7 text-nowrap" title="'+(a.songname||"SHANG")+'">'+(a.songname||"SHANG")+'</div><div class="col-md-4 col-xs-5 text-nowrap" title="'+(a.artistname||"SHANG")+'">'+(a.artistname||"SHANG")+"</div></div>"),c.on("click",function(){var t=$(this).data("songid")+"";i(t)}),o.append(c)}n.append(o),$(".textdiv").html(""),$(".textdiv").append(n),$("#ensurebtn").hide(),$("#showtext").modal("show"),$("#showtext").one("hidden.bs.modal",function(){$("#ensurebtn").show()})})}function r(t,e){var n=I[t].rate128;return/pan.baidu/.test(n.mp3)?($(".textdiv").html("此音乐为百度网盘音乐, 删除并播放下一首?"),$("#ensurebtn").show(),$("#showtext").modal("show"),void $("#ensurebtn").one("click",function(){1!==I.length&&s(1),S.find("li").each(function(){$(this).find("img").first().trigger("click")})})):(u&&document.body.removeChild(u),u=document.createElement("audio"),u.innerHTML="<source src="+n.mp3+">",document.body.appendChild(u),u.volume=G,u.play(),j=t,$(u).on("timeupdate",function(){l()}),$(u).on("ended",function(){s(1)}),P=shangLrcLoad(u,"lrcdiv"),jsonpGet("http://cors.coding.io?method=get&url="+n.lrc,function(t){P.parseLrc(t.data),P.repaireTimeNu=n.repaireTimeNu||0,P.init()}),void a(n,t,e))}function a(t,e,n){N.html(t.title||"SHANG"),L.html(t.artist||"SHANG"),k.attr("src",t.cover||"http://i1.tietuku.com/f3f9084123926501.jpg"),n&&c(t,e);for(var i=0;i<O.length;i++)O[i].removeClass("playing");O[e].addClass("playing")}function c(t,e){var n=t.time||0,i=Math.floor(n/60),o=Math.round(n%60)<10?"0"+Math.round(n%60):Math.round(n%60),a=$("<li>");a.on("click",function(){r(e,!1)}),a.html('<hr><div class="row"> <div class="col-md-8 col-xs-7 text-nowrap" title="'+(t.title||"SHANG")+'">'+(t.title||"SHANG")+'</div><div class="col-md-2 col-xs-3 text-right">'+(i+":"+o)+'</div><div class="col-md-1 col-xs-1"><img class="visible-xs" src="images/delete.png" alt="删除"/></div></div>'),S.append(a),a.on("mouseover",function(){$(this).addClass("maydelete"),$(this).find("img").removeClass("visible-xs"),$(this).find("img").css("display","block")}),a.on("mouseout",function(){$(this).removeClass("maydelete"),$(this).find("img").addClass("visible-xs"),$(this).find("img").css("display","none")}),a.find("img").on("click",function(t){j===e?1===I.length?d():s(1):j>e&&j--,I.splice(e,1),O.splice(e,1),S.find("li").remove(".maydelete"),U.playlistinfo=I,localStorage.shang_music=JSON.stringify(U),t.stopPropagation()}),O.push(a)}function s(t){-1!==j&&(j=(j+I.length+t)%I.length,r(j,!1))}function l(){if(u){var t=u.currentTime,e=Math.floor(t/60),n=Math.round(t%60)<10?"0"+Math.round(t%60):Math.round(t%60);_.html(e+":"+n),R||T.width(u.currentTime/u.duration*100+"%")}}function d(){u&&(document.body.removeChild(u),u=null,j=-1),S.html(""),$("#lrcdiv").html(""),N.html("SHANG"),L.html("SHANG"),k.attr("src","http://i1.tietuku.com/f3f9084123926501.jpg"),T.width(0),_.html("")}var u=null,m=$("#addandplay"),h=$(".mayplay"),f=$("#addr"),p=$("#playpaush"),g=$("#previewsong"),v=$("#nextsong"),b=$("#mute"),w=$("#volumebar"),x=$("#currentvolumebar"),y=$("#progressbar"),T=$("#currentprogress"),k=$("#coverimg"),N=$("#title"),L=$("#artist"),_=$("#info"),S=$("#alllistul"),C=$("#lrctimereduce"),M=$("#lrctimeadd"),H=$("#lrctimecurrent"),j=-1,G=1,I=[],O=[],A=!0,E=null,X=localStorage.shang_music,U={};if(X&&(U=JSON.parse(X))){I=U.playlistinfo||[];for(var J=0;J<I.length;J++)c(I[J].rate128,J)}var P,R=!1,q=y.width(),D=!1,B=w.width();$(document).on("mousedown",function(){(R||D)&&(document.body.style.cursor="pointer")}),$(document).on("mouseup",function(t){e(t,!0),n(t),R=!1,D=!1,document.body.style.cursor="default"}),$(document).on("mousemove",function(t){return e(t),n(t),"addr"===t.target.id}),y.on("mousedown",function(){R=!0}),w.on("mousedown",function(){D=!0}),f.on("focus",function(){f.select()}),C.on("click",function(){t(-1)}),M.on("click",function(){t(1)}),H.on("click",function(){t(0)}),$("#showtext").on("hidden.bs.modal",function(){h.first().button("reset"),$("#ensurebtn").show(),$("#ensurebtn").unbind(),$("#notsurebtn").html("关闭"),$("#notsurebtn").unbind(),clearTimeout(E)}),h.each(function(t){!function(t,e){$(e).on("click",function(){h.first().button("loading"),E=setTimeout(function(){m.button("reset")},5e3);var e=f.val().match("\\d+"),n="";e?1===t?(n=e[0],i(n)):($("#notsurebtn").html("否"),$(".textdiv").html("检测到ID,直接播放?"),$("#showtext").modal("show"),$("#ensurebtn").one("click",function(){n=e[0],i(n)}),$("#notsurebtn").one("click",function(){$("#notsurebtn").html("关闭"),i("")})):i("")})}(t,this)}),m.on("click",function(){m.button("loading"),E=setTimeout(function(){m.button("reset")},1e4);var t=f.val().match("\\d+"),e="";t&&(e=t[0]);for(var n=-1,i=0;i<I.length;i++)if(e===I[i].rate128.id){n=i;break}if(-1!==n)return $(".textdiv").html("已经在列表中,点击确定跳转播放"),$("#showtext").modal("show"),void $("#ensurebtn").one("click",function(){$("#showtext").modal("hide"),j=n,r(j)});var o={};I.push(o),getbdmInfo(e,[],function(t){o["rate"+t.rate]=t,"128"===t.rate&&(m.button("reset"),j=I.length-1,r(j,!0),U.playlistinfo=I,localStorage.shang_music=JSON.stringify(U))})}),g.on("click",function(){s(-1)}),v.on("click",function(){s(1)}),b.on("click",function(){u&&(u.muted?(u.muted=!1,b.attr("src","./images/volume.png")):(u.muted=!0,b.attr("src","./images/mute.png")))}),p.on("click",function(){u&&(A?(u.pause(),p.attr("src","./images/play.png"),A=!1):(u.play(),p.attr("src","./images/pause.png"),A=!0))})});